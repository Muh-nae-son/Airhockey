// ESP32 PWM + RPM reader for PC fans (2-fan example)
// - PWM on GPIO16 (one channel, shared by all fans)
// - Fan1 tach: GPIO32
// - Fan2 tach: GPIO33
//
// Each fan outputs 2 pulses per revolution.

#include <Arduino.h>

// PWM Output
const int FAN_PWM_PIN = 16;
const int FAN_PWM_CHANNEL = 0;
const int FAN_PWM_FREQ = 25000;   // 25 kHz
const int FAN_PWM_RESOLUTION = 8; // 0–255

// Tach pins
const int FAN1_TACH_PIN = 32;
const int FAN2_TACH_PIN = 33;

// Tach counters (must be volatile, updated in ISR)
volatile uint32_t fan1_pulses = 0;
volatile uint32_t fan2_pulses = 0;

// Last computed RPM
int fan1_rpm = 0;
int fan2_rpm = 0;

// Interrupt service routines
void IRAM_ATTR fan1_tach_isr() {
  fan1_pulses++;
}

void IRAM_ATTR fan2_tach_isr() {
  fan2_pulses++;
}

void setup() {
  Serial.begin(115200);
  delay(500);

  // ----- PWM setup on ESP32 -----
  // ledcSetup(FAN_PWM_CHANNEL, FAN_PWM_FREQ, FAN_PWM_RESOLUTION);
  // ledcAttachPin(FAN_PWM_PIN, FAN_PWM_CHANNEL);

   ledcAttachChannel(FAN_PWM_PIN, FAN_PWM_FREQ, FAN_PWM_RESOLUTION, FAN_PWM_CHANNEL);

  // Start with, say, 50% duty
  uint8_t duty = 100; // 0–255
  ledcWrite(FAN_PWM_PIN, duty);

  // ----- Tach input pins -----
  pinMode(FAN1_TACH_PIN, INPUT);
  pinMode(FAN2_TACH_PIN, INPUT);

  attachInterrupt(digitalPinToInterrupt(FAN1_TACH_PIN), fan1_tach_isr, FALLING);
  attachInterrupt(digitalPinToInterrupt(FAN2_TACH_PIN), fan2_tach_isr, FALLING);

  Serial.println("ESP32 Fan Controller (2-fan RPM example) started");
}

void loop() {
  static uint32_t lastMillis = 0;
  uint32_t now = millis();

  // Compute RPM once per second
  if (now - lastMillis >= 1000) {
    lastMillis = now;

    // Safely copy and reset pulse counts
    noInterrupts();
    uint32_t pulses1 = fan1_pulses;
    uint32_t pulses2 = fan2_pulses;
    fan1_pulses = 0;
    fan2_pulses = 0;
    interrupts();

    // Each revolution = 2 pulses
    if (pulses1 < 2) fan1_rpm = 0;
    else fan1_rpm = (pulses1 / 2) * 60;

    if (pulses2 < 2) fan2_rpm = 0;
    else fan2_rpm = (pulses2 / 2) * 60;

    // Print
    Serial.print("Fan1 RPM: ");
    Serial.print(fan1_rpm);
    Serial.print("   Fan2 RPM: ");
    Serial.println(fan2_rpm);
  }

}
